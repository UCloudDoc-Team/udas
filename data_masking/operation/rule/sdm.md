# 2、静态脱敏

静态脱敏模块主要是对数据库以及文件脱敏任务的管理，添加脱敏任务、执行脱敏任务、删除脱敏任务、查看任务的执行详细信息等。

## 2.1 数据库脱敏

主要是对数据库脱敏任务的配置，在该模块中可以实现数据库到数据库脱敏任务的添加，以及数据库到EXCEL、TXT、DEL、CSV文件脱敏任务的添加。

### 2.1.1 添加任务

文档中以Oracle数据库到Oracle数据库脱敏任务的添加为例：

点击界面“添加”按钮，进入添加脱敏作业界面。

![](/images/operation/rule/sdm/sdm_1.png) 

添加和选择如下信息：

| 任务名称       | Test                                  |
| -------------- | ------------------------------------- |
| 脱敏类型       | 目标数据库（默认）                    |
| 源数据库       | oracle11g（可以根据需要选择源数据库） |
| 目标数据库     | 99（可以根据需要选择目标数据库）      |
| 表名称变更     | 启用前缀（默认）                      |
| 词缀内容       | AAB（自定义）                         |
| 数据处理       | 清除（默认）                          |
| 非敏感数据处理 | 保留原值（默认）                      |
| 执行方式       | 手动执行（默认）                      |

a. 脱敏类型：目前有数据库到数据库以及数据库到文件两种类型。数据库到数据库支持同构脱敏（例如Oracle到Oracle数据库脱敏）也支持异构脱敏（例如Oracle到MySQL数据库脱敏），数据库到文件支持到Excel、dev、txt和csv等四种的脱敏。

b. 源数据库：通过修改 按钮对数据源配置管理模块的源数据库中审核通过的数据库进行选择。

目标数据库：通过修改按钮对数据源配置管理模块的目标数据库中审核通过的数据库进行选择。

c. 表名称变更：启用前缀即在目标库中对脱敏表名添加一个前缀，启用后缀即在目标库中对脱敏表名添加一个后缀，保持一致即目标库中脱敏表名与源库中的表名相同。

d. 词缀内容：基于表名称变更的选择，启用前缀和启用后缀时为必填项，保持一致时系统自动隐藏。

e. 数据处理：清除即目标表中如果有同名表，则会清空该表的数据，然后插入脱敏后的数据；重建即目标库中如果有同名表，则会直接删除同名表，新建需要脱敏的表。

f. 非敏感数据处理：表中的非敏感数据的处理方式。保留原值即敏感字段中的非敏感数据不做任何处理插入到目标表中；字段置空即敏感字段中的非敏感数据的那个单元格变成设置为空值；该行置空即敏感字段中包含非敏感数据的一行数据不会脱敏到目标表中；变形处理就是敏感字段中的非敏感数据脱敏成符合该行敏感类型的数据。

g. 执行方式：可参考第1.2.1中执行方式的描述。

添加上述信息之后，点击“下一步”，选择要脱敏的表和字段。![](/images/operation/rule/sdm/sdm_2.png)

点击“下一步”进行脱敏范围的确认，默认过滤类型为“全部”即脱敏所选表中的所有数据。

![](/images/operation/rule/sdm/sdm_3.png)

过滤类型：支持全部、条件和数量。

a. 条件：可对输入的sql语句进行校验，如果选择条件则该任务仅会脱敏符合sql语句校验的数据；

b. 数量：在过滤范围输入框中输入数字，例如输入200则该任务仅会脱敏所选表的200条数据。

点击“下一步”，在规则匹配页面可以对敏感字段的脱敏规则进行选择。

![](/images/operation/rule/sdm/sdm_4.png)

a. 应用规则组：此功能的前提是该数据库进行了敏感数据扫描的操作，应用规则组只可给匹配上了敏感类型的字段应用对应敏感类型的脱敏规则。系统中内置5种规则组，也可应用自定义的规则组[5.5.3脱敏规则组](#_5.5.3_脱敏规则组)

b. 水印规则：功能同应用规则组，选择水印规则后点击前面的复选框，可以默认给每个表的第一字段应用上所选的水印规则

注：需要注意对不同数据水印类型选择，字符的数据类型就选择字符水印规则，时间或者数字的数据类型就选择数字水印规则；脱敏如果选择加密算法脱敏后可能存在脱敏后数据超过字段长度限制的问题   

对字段选择完脱敏、水印规则后，点击“完成”按钮即完成一个数据库到数据库应用随机脱敏规则的脱敏任务。任务创建完成后审核状态默认为未审核状态，仅有审核通过的任务才可被执行。

![](/images/operation/rule/sdm/sdm_5.png)

### 2.1.2 修改任务

修改脱敏任务需要点击任务栏右侧操作一栏中的修改按钮，系统会提示“此操作将会清空作业信息，是否继续”，点击“确认”即可对任务进行修改操作。

![](/images/operation/rule/sdm/sdm_6.png)  

修改脱敏任务时，任务名称不可修改，其他均可以操作修改。修改后的脱敏任务审核状态会变为未审核，执行状态变为未启动。  

![](/images/operation/rule/sdm_7.png)

### 2.1.3 删除任务

选中任务前面的复选框，点击“删除”按钮即可完成脱敏任务的删除。系统支持批量删除，整页删除的操作。如下所示：

![](/images/operation/rule/sdm/sdm_8.png)  

选中之后点击删除按钮，在弹出的提示框中点击“确认”按钮删除脱敏任务。

![](/images/operation/rule/sdm/sdm_9.png)

注意：正在进行中的脱敏任务不能进行删除。

#### 2.1.4 更多操作

在任务列表的操作栏中的更多按钮中有样本对比、任务周期修改、查看运行日志以及数据库脱敏到文件下载文件的功能。

样本对比：样本对比会显示目标库中随机的10条数据进行脱敏后效果展示，可对敏感字段选择的脱敏规则进行确认。示例中展示的是随机脱敏方式的样本对比：  

![](/images/operation/rule/sdm/sdm_10.png)

添加成功后， 未审核任务没有开始按钮。需等待审核员审核通过后，才可点击开始按钮，开始执行文件脱敏任务。  

![](/images/operation/rule/sdm/sdm_10.png)

修改周期：可将任务修改为定时、周期执行的任务。设置对应的时间，点击修改即可。

![](/images/operation/rule/sdm/sdm_11.png)

运行日志：运行日志中记录了已执行过的任务的脱敏日志。

![](/images/operation/rule/sdm/sdm_12.png)

下载：仅有数据库到文件的脱敏任务且任务状态为已完成的状态才会有下载按钮。通过该按钮可以获取脱敏后的文件。

![](/images/operation/rule/sdm/sdm_13.png)

详情：点击任务操作栏中的详情按钮，进入查看任务详情界面。详情展示了任务中数据库的基本配置信息、脱敏表数量、脱敏成功率、脱敏表总字段数、脱敏的表名、表的脱敏状态、源表数据量、脱敏数据量、脱敏速率等信息。若表脱敏失败，在该表的的描述栏中会展示失败的具体原因等信息。

![](/images/operation/rule/sdm/sdm_14.png)

搜索：在任务列表上方的搜索框输入内容对任务名称进行模糊搜索。

![](/images/operation/rule/sdm/sdm_15.png)

筛选：在表头可根据目标类型、任务状态、审核状态的分类进行筛选。选择类型之后点击“筛选”即可。点击“重置”则恢复到默认状态，以审核状态为例：

![](/images/operation/rule/sdm/sdm_16.png)

## 2.2 文件脱敏

该模块主要是对文件脱敏到文件或者文件脱敏到数据库脱敏任务的添加，目前脱敏系统支持Excel、CSV、TXT、DEL、 DUMP等五种格式的文件脱敏。其中DUMP文件只支持使用exp方式导出的DUMP文件脱敏，Excel、CSV、TXT、DEL均为结构化的文件。

### 2.2.1 添加任务

点击“添加”按钮，选择脱敏文件上传及选择脱敏目标类型。当选择脱敏到数据库时，需要选择目标数据库和数据处理方式。

![](/images/operation/rule/sdm/sdm_17.png)                              

然后再根据需要对脱敏的文件格式进行选择配置。

![](/images/operation/rule/sdm/sdm_18.png)

文件编码格式、记录分隔符、文本识别符、字段分隔符可以通过一些文本编辑工具来查看。

 ![](/images/operation/rule/sdm/sdm_19.png) 

最后选择脱敏规则组名和执行方式，完成任务的添加。脱敏规则组可以手动添加也可以选择默认的；执行方式包括手动执行、周期执行和定时执行。详见本文第5.1.2.1节描述。

  ![](/images/operation/rule/sdm/sdm_20.png)

注：任务添加成功后可以根据操作栏中的样本对比进行任务的检查，样本对比成功是脱敏任务成功执行的前提之一。

### 2.2.2 修改任务

点击右侧操作栏中的  按钮进入任务修改界面。文件任务修改功能可修改除任务名之外的配置信息，修改完成后该任务审核状态变为未审核。需再次审核通过后才可执行脱敏任务。

  ![](/images/operation/rule/sdm/sdm_21.png)

### 2.2.3 删除任务

删除文件脱敏任务与删除数据库脱敏任务一样，选择之后点击“删除”按钮，在弹窗上点击确认即可。

  ![](/images/operation/rule/sdm/sdm_22.png)

### 2.2.4 更多操作

文件脱敏任务同数据库脱敏，有样本对比、运行日志、任务详情查看、搜索和筛选功能。仅有文件到文件且任务状态为已完成的状态才支持文件下载。

注意：若脱敏的行数大于65536行时，会分成几个Excel文件进行存储。因此下载执行脱敏到Excel文件中的任务文件时会出现几个Excel文件。

## 2.3 消息队列脱敏

该模块主要对kafka脱敏任务的管理，例如新增修改任务、删除任务、查看任务详情、启动任务等。

### 2.3.1 添加任务

在消息队列脱敏模块中点击“添加”按钮，在编辑任务页面输入任务名称，选择源目消息队列，点击“下一步”。

 ![](/images/operation/rule/sdm/sdm_23.png)                               

在敏感信息配置页面输入如下配置信息

 ![](/images/operation/rule/sdm/sdm_24.png) 

输入如下内容：

| 配置方式 | 样本识别                                                     |
| -------- | ------------------------------------------------------------ |
| 样本识别 | {"name":"张三","tel":"13598987676","address":"广东省深圳市宝安区"} |

a. 匹配方式：系统支持样本识别和手动添加两种方式。默认样本识别，样本识别输入框中输入单层格式的json格式字符串，点击“识别”即可识别出json格式中的key值。手动添加则手动输入字段名称与敏感类型，点击“新增”即可。

  ![](/images/operation/rule/sdm/sdm_25.png)

对字段选择对应敏感类型的脱敏规则，点击“保存”完成kafka脱敏任务的添加。

  ![](/images/operation/rule/sdm/sdm_26.png)

同前面的脱敏任务一致，任务仅有审核通过才可被启动。

### 2.3.2 更多操作

删除：kafka脱敏任务的删除可以进行批量操作和单一操作，点击任务列表左侧的  按钮来完成脱敏任务的选择，然后点击删除按钮就可以删除选中的kafka脱敏任务；

修改：修改任务点击右侧操作栏中的  即可对任务配置进行修改；

查看任务详情：点击任务操作栏的  按钮即可查看任务的详细配置信息，如下所示：

 ![](/images/operation/rule/sdm/sdm_27.png)
